# Group Vote — Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Build a web-based voting system for a ~35-40 member anesthesia group with anonymous voting, ranked choice, quorum rules, and participation tracking.

**Architecture:** Next.js App Router with Supabase backend. Server components for data fetching, server actions for mutations. Supabase handles auth (magic links) and PostgreSQL with row-level security for vote privacy. Resend for transactional email.

**Tech Stack:** Next.js 14+, Supabase, Tailwind CSS, Resend, Vercel

---

## Phase 1: Project Setup

### Task 1.1 — Initialize Next.js with Tailwind CSS

**Files:**
- `package.json` (generated)
- `next.config.ts` (generated)
- `tailwind.config.ts` (generated)
- `postcss.config.mjs` (generated)
- `tsconfig.json` (generated)
- `src/app/layout.tsx` (generated)
- `src/app/page.tsx` (generated)
- `src/app/globals.css` (generated)

**Steps:**

1. Create the Next.js project with TypeScript, Tailwind, App Router, and `src/` directory:

```bash
cd /Users/briantse/Projects/group-vote
npx create-next-app@latest . --typescript --tailwind --eslint --app --src-dir --import-alias "@/*" --use-npm --turbopack
```

When prompted, accept all defaults. The `--use-npm` flag ensures npm is used (matching your npm 10.9.2). The `.` tells it to initialize in the current directory.

2. Verify the project runs:

```bash
cd /Users/briantse/Projects/group-vote
npm run dev
```

Open `http://localhost:3000` in a browser to confirm the default Next.js page loads. Then stop the dev server (Ctrl+C).

3. Clean up the default `src/app/page.tsx` to a minimal placeholder:

```tsx
// src/app/page.tsx
export default function Home() {
  return (
    <main className="flex min-h-screen items-center justify-center">
      <h1 className="text-3xl font-bold">Group Vote</h1>
    </main>
  );
}
```

4. Commit:

```bash
git add -A
git commit -m "Initialize Next.js project with TypeScript, Tailwind, App Router"
```

---

### Task 1.2 — Install Dependencies

**Files:**
- `package.json` (modified)
- `package-lock.json` (modified)

**Steps:**

1. Install Supabase client libraries:

```bash
cd /Users/briantse/Projects/group-vote
npm install @supabase/supabase-js @supabase/ssr
```

2. Install Resend SDK for email:

```bash
npm install resend
```

3. Install development utilities:

```bash
npm install -D supabase
```

4. Verify `package.json` contains all dependencies. Run `npm ls @supabase/supabase-js @supabase/ssr resend` and confirm no errors.

5. Commit:

```bash
git add package.json package-lock.json
git commit -m "Add Supabase, Resend, and dev dependencies"
```

---

### Task 1.3 — Environment Configuration

**Files:**
- `/Users/briantse/Projects/group-vote/.env.local` (create)
- `/Users/briantse/Projects/group-vote/.env.example` (create)
- `/Users/briantse/Projects/group-vote/.gitignore` (modify — confirm `.env.local` is listed)

**Steps:**

1. Create `.env.example` with all required variables (no real values):

```env
# Supabase
NEXT_PUBLIC_SUPABASE_URL=https://your-project.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=your-anon-key
SUPABASE_SERVICE_ROLE_KEY=your-service-role-key

# Resend
RESEND_API_KEY=re_your-api-key

# App
NEXT_PUBLIC_APP_URL=http://localhost:3000
```

2. Create `.env.local` with the same structure. Fill in real Supabase credentials from the Supabase dashboard (Settings → API). Leave `RESEND_API_KEY` as a placeholder for now.

```env
# Supabase
NEXT_PUBLIC_SUPABASE_URL=
NEXT_PUBLIC_SUPABASE_ANON_KEY=
SUPABASE_SERVICE_ROLE_KEY=

# Resend
RESEND_API_KEY=

# App
NEXT_PUBLIC_APP_URL=http://localhost:3000
```

3. Confirm `.gitignore` (generated by create-next-app) already includes `.env*.local`. If not, add it.

4. Commit (only the example file — never commit `.env.local`):

```bash
git add .env.example .gitignore
git commit -m "Add environment variable template"
```

---

### Task 1.4 — Supabase Client Setup

**Files:**
- `/Users/briantse/Projects/group-vote/src/lib/supabase/client.ts` (create)
- `/Users/briantse/Projects/group-vote/src/lib/supabase/server.ts` (create)
- `/Users/briantse/Projects/group-vote/src/lib/supabase/middleware.ts` (create)
- `/Users/briantse/Projects/group-vote/src/lib/supabase/admin.ts` (create)

**Steps:**

1. Create the browser client (used in Client Components):

```ts
// src/lib/supabase/client.ts
import { createBrowserClient } from "@supabase/ssr";

export function createClient() {
  const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL;
  const supabaseAnonKey = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY;

  if (!supabaseUrl || !supabaseAnonKey) {
    throw new Error(
      "Missing Supabase environment variables: NEXT_PUBLIC_SUPABASE_URL and NEXT_PUBLIC_SUPABASE_ANON_KEY are required"
    );
  }

  return createBrowserClient(supabaseUrl, supabaseAnonKey);
}
```

2. Create the server client (used in Server Components, Route Handlers, and Server Actions):

```ts
// src/lib/supabase/server.ts
import { createServerClient } from "@supabase/ssr";
import { cookies } from "next/headers";

export async function createClient() {
  const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL;
  const supabaseAnonKey = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY;

  if (!supabaseUrl || !supabaseAnonKey) {
    throw new Error(
      "Missing Supabase environment variables: NEXT_PUBLIC_SUPABASE_URL and NEXT_PUBLIC_SUPABASE_ANON_KEY are required"
    );
  }

  const cookieStore = await cookies();

  return createServerClient(supabaseUrl, supabaseAnonKey, {
    cookies: {
      getAll() {
        return cookieStore.getAll();
      },
      setAll(cookiesToSet) {
        try {
          cookiesToSet.forEach(({ name, value, options }) =>
            cookieStore.set(name, value, options)
          );
        } catch {
          // The `setAll` method is called from a Server Component where
          // cookies cannot be set. This can be ignored if you have
          // middleware refreshing user sessions.
        }
      },
    },
  });
}
```

3. Create the middleware helper (refreshes auth tokens on every request):

```ts
// src/lib/supabase/middleware.ts
import { createServerClient } from "@supabase/ssr";
import { NextResponse, type NextRequest } from "next/server";

export async function updateSession(request: NextRequest) {
  const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL;
  const supabaseAnonKey = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY;

  if (!supabaseUrl || !supabaseAnonKey) {
    throw new Error(
      "Missing Supabase environment variables: NEXT_PUBLIC_SUPABASE_URL and NEXT_PUBLIC_SUPABASE_ANON_KEY are required"
    );
  }

  let supabaseResponse = NextResponse.next({ request });

  const supabase = createServerClient(supabaseUrl, supabaseAnonKey, {
    cookies: {
      getAll() {
        return request.cookies.getAll();
      },
      setAll(cookiesToSet) {
        cookiesToSet.forEach(({ name, value }) =>
          request.cookies.set(name, value)
        );
        supabaseResponse = NextResponse.next({ request });
        cookiesToSet.forEach(({ name, value, options }) =>
          supabaseResponse.cookies.set(name, value, options)
        );
      },
    },
  });

  // Refresh the auth token — this is the critical call
  await supabase.auth.getUser();

  return supabaseResponse;
}
```

4. Create the admin client (bypasses RLS — used only in server-side admin operations):

```ts
// src/lib/supabase/admin.ts
import { createClient } from "@supabase/supabase-js";

export function createAdminClient() {
  const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL;
  const serviceRoleKey = process.env.SUPABASE_SERVICE_ROLE_KEY;

  if (!supabaseUrl || !serviceRoleKey) {
    throw new Error(
      "Missing Supabase admin environment variables: NEXT_PUBLIC_SUPABASE_URL and SUPABASE_SERVICE_ROLE_KEY are required"
    );
  }

  return createClient(supabaseUrl, serviceRoleKey, {
    auth: {
      autoRefreshToken: false,
      persistSession: false,
    },
  });
}
```

5. Commit:

```bash
git add src/lib/supabase/
git commit -m "Add Supabase client utilities (browser, server, middleware, admin)"
```

---

### Task 1.5 — Folder Structure Scaffold

**Files:**
- `/Users/briantse/Projects/group-vote/src/app/(auth)/login/page.tsx` (create placeholder)
- `/Users/briantse/Projects/group-vote/src/app/(auth)/auth/confirm/route.ts` (create placeholder)
- `/Users/briantse/Projects/group-vote/src/app/(protected)/dashboard/page.tsx` (create placeholder)
- `/Users/briantse/Projects/group-vote/src/app/(protected)/votes/page.tsx` (create placeholder)
- `/Users/briantse/Projects/group-vote/src/app/(protected)/votes/[id]/page.tsx` (create placeholder)
- `/Users/briantse/Projects/group-vote/src/app/(protected)/votes/new/page.tsx` (create placeholder)
- `/Users/briantse/Projects/group-vote/src/app/(protected)/propose/page.tsx` (create placeholder)
- `/Users/briantse/Projects/group-vote/src/app/(protected)/admin/members/page.tsx` (create placeholder)
- `/Users/briantse/Projects/group-vote/src/app/(protected)/admin/votes/page.tsx` (create placeholder)
- `/Users/briantse/Projects/group-vote/src/app/(protected)/admin/proposals/page.tsx` (create placeholder)
- `/Users/briantse/Projects/group-vote/src/app/(protected)/admin/participation/page.tsx` (create placeholder)
- `/Users/briantse/Projects/group-vote/src/app/(protected)/layout.tsx` (create)
- `/Users/briantse/Projects/group-vote/src/components/ui/` (create directory)
- `/Users/briantse/Projects/group-vote/src/lib/types.ts` (create)
- `/Users/briantse/Projects/group-vote/src/lib/constants.ts` (create)

**Steps:**

1. Create route group directories. The `(auth)` group is for unauthenticated pages; `(protected)` is for pages requiring login:

```bash
cd /Users/briantse/Projects/group-vote
mkdir -p src/app/\(auth\)/login
mkdir -p src/app/\(auth\)/auth/confirm
mkdir -p src/app/\(protected\)/dashboard
mkdir -p src/app/\(protected\)/votes/new
mkdir -p "src/app/(protected)/votes/[id]"
mkdir -p src/app/\(protected\)/propose
mkdir -p src/app/\(protected\)/admin/members
mkdir -p src/app/\(protected\)/admin/votes
mkdir -p src/app/\(protected\)/admin/proposals
mkdir -p src/app/\(protected\)/admin/participation
mkdir -p src/components/ui
```

2. Create the shared TypeScript types file:

```ts
// src/lib/types.ts
export type MemberRole = "admin" | "member";

export type VoteFormat = "yes_no" | "multiple_choice" | "ranked_choice";

export type PrivacyLevel = "anonymous" | "admin_visible" | "open";

export type VoteStatus = "draft" | "pending_review" | "open" | "closed";

export type ProposalStatus = "pending" | "approved" | "rejected";

export type PassingThreshold =
  | "simple_majority"
  | "two_thirds"
  | "three_quarters"
  | "custom";

export interface Member {
  id: string;
  email: string;
  name: string | null;
  role: MemberRole;
  active: boolean;
  created_at: string;
}

export interface Vote {
  id: string;
  title: string;
  description: string | null;
  format: VoteFormat;
  privacy_level: PrivacyLevel;
  status: VoteStatus;
  quorum_percentage: number;
  passing_threshold: PassingThreshold;
  custom_threshold_percentage: number | null;
  deadline: string | null;
  created_by: string;
  created_at: string;
  closed_at: string | null;
}

export interface VoteOption {
  id: string;
  vote_id: string;
  label: string;
  description: string | null;
  display_order: number;
}

export interface ParticipationRecord {
  id: string;
  vote_id: string;
  member_id: string;
  voted_at: string;
  updated_at: string;
}

export interface BallotRecordAnonymous {
  id: string;
  vote_id: string;
  choice: string; // JSON: option_id for single choice, array of option_ids for ranked
  cast_at: string;
}

export interface BallotRecordNamed {
  id: string;
  vote_id: string;
  member_id: string;
  choice: string; // JSON: option_id for single choice, array of option_ids for ranked
  cast_at: string;
}

export interface VoteProposal {
  id: string;
  proposed_by: string;
  title: string;
  description: string | null;
  format: VoteFormat;
  privacy_level: PrivacyLevel;
  options: string; // JSON array of {label, description}
  quorum_percentage: number;
  passing_threshold: PassingThreshold;
  custom_threshold_percentage: number | null;
  status: ProposalStatus;
  admin_notes: string | null;
  created_at: string;
}
```

3. Create the constants file:

```ts
// src/lib/constants.ts
export const QUORUM_DEFAULT = 75; // 75% of members must vote
export const SESSION_EXPIRY_DAYS = 7;
export const MAGIC_LINK_EXPIRY_MINUTES = 15;

export const PASSING_THRESHOLD_LABELS: Record<string, string> = {
  simple_majority: "Simple Majority (>50%)",
  two_thirds: "Two-Thirds (≥66.7%)",
  three_quarters: "Three-Quarters (≥75%)",
  custom: "Custom Percentage",
};

export const VOTE_FORMAT_LABELS: Record<string, string> = {
  yes_no: "Yes / No",
  multiple_choice: "Multiple Choice",
  ranked_choice: "Ranked Choice",
};

export const PRIVACY_LEVEL_LABELS: Record<string, string> = {
  anonymous: "Anonymous",
  admin_visible: "Admin-Visible",
  open: "Open",
};
```

4. Create placeholder pages. Each placeholder follows this pattern so the app compiles:

```tsx
// src/app/(auth)/login/page.tsx
export default function LoginPage() {
  return <div>Login — to be implemented</div>;
}
```

```tsx
// src/app/(protected)/dashboard/page.tsx
export default function DashboardPage() {
  return <div>Dashboard — to be implemented</div>;
}
```

Create similar one-liner placeholders for all the other pages listed in the Files section above.

5. Create the auth confirm route handler placeholder:

```ts
// src/app/(auth)/auth/confirm/route.ts
import { NextResponse } from "next/server";

export async function GET() {
  // Will handle magic link confirmation in Phase 3
  return NextResponse.redirect(new URL("/dashboard", process.env.NEXT_PUBLIC_APP_URL || "http://localhost:3000"));
}
```

6. Create the protected layout:

```tsx
// src/app/(protected)/layout.tsx
export default function ProtectedLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  return <>{children}</>;
}
```

7. Verify the app still compiles:

```bash
cd /Users/briantse/Projects/group-vote
npm run build
```

Fix any TypeScript errors before continuing.

8. Commit:

```bash
git add -A
git commit -m "Scaffold folder structure, types, constants, and placeholder pages"
```

---

## Phase 2: Database Schema

### Task 2.1 — Create Supabase Migration with Full Schema

**Files:**
- `/Users/briantse/Projects/group-vote/supabase/migrations/00001_initial_schema.sql` (create)

**Steps:**

1. Initialize the Supabase local development setup:

```bash
cd /Users/briantse/Projects/group-vote
npx supabase init
```

This creates a `supabase/` directory with a `config.toml`.

2. Create the migrations directory:

```bash
mkdir -p /Users/briantse/Projects/group-vote/supabase/migrations
```

3. Create the migration file with the complete schema:

```sql
-- supabase/migrations/00001_initial_schema.sql
-- Group Vote — Full Database Schema
-- ============================================================

-- Enable UUID generation
create extension if not exists "pgcrypto";

-- ============================================================
-- ENUM TYPES
-- ============================================================

create type member_role as enum ('admin', 'member');
create type vote_format as enum ('yes_no', 'multiple_choice', 'ranked_choice');
create type privacy_level as enum ('anonymous', 'admin_visible', 'open');
create type vote_status as enum ('draft', 'pending_review', 'open', 'closed');
create type proposal_status as enum ('pending', 'approved', 'rejected');
create type passing_threshold as enum ('simple_majority', 'two_thirds', 'three_quarters', 'custom');

-- ============================================================
-- TABLE: members
-- ============================================================
-- The allowlist of eligible voters. Each row corresponds to one
-- real person. The `auth_user_id` column links to Supabase Auth
-- once the member has logged in at least once.
-- ============================================================

create table members (
  id            uuid primary key default gen_random_uuid(),
  auth_user_id  uuid unique references auth.users(id) on delete set null,
  email         text not null unique,
  name          text,
  role          member_role not null default 'member',
  active        boolean not null default true,
  created_at    timestamptz not null default now(),
  updated_at    timestamptz not null default now()
);

comment on table members is 'Allowlist of eligible group members';
comment on column members.auth_user_id is 'Links to Supabase auth.users once the member first authenticates';
comment on column members.active is 'Inactive members cannot log in or vote but are retained for history';

-- ============================================================
-- TABLE: votes
-- ============================================================
-- A single vote/ballot that the group acts on. Contains all
-- configuration: format, privacy, thresholds, and deadline.
-- ============================================================

create table votes (
  id                          uuid primary key default gen_random_uuid(),
  title                       text not null,
  description                 text,
  format                      vote_format not null,
  privacy_level               privacy_level not null default 'anonymous',
  status                      vote_status not null default 'draft',
  quorum_percentage           integer not null default 75
                                check (quorum_percentage >= 0 and quorum_percentage <= 100),
  passing_threshold           passing_threshold not null default 'simple_majority',
  custom_threshold_percentage integer
                                check (custom_threshold_percentage is null
                                       or (custom_threshold_percentage > 0 and custom_threshold_percentage <= 100)),
  deadline                    timestamptz,
  created_by                  uuid not null references members(id),
  created_at                  timestamptz not null default now(),
  opened_at                   timestamptz,
  closed_at                   timestamptz,

  -- If passing_threshold is 'custom', a percentage must be provided
  constraint custom_threshold_required
    check (passing_threshold != 'custom' or custom_threshold_percentage is not null)
);

comment on table votes is 'A vote/ballot that the group acts on';
comment on column votes.deadline is 'Null means open-ended (admin manually closes)';
comment on column votes.opened_at is 'Timestamp when the vote status was changed to open';

-- ============================================================
-- TABLE: vote_options
-- ============================================================
-- The choices available on a vote. For yes/no votes, two rows
-- are auto-created ("Yes" and "No"). For multiple choice or
-- ranked choice, the admin defines the options.
-- ============================================================

create table vote_options (
  id             uuid primary key default gen_random_uuid(),
  vote_id        uuid not null references votes(id) on delete cascade,
  label          text not null,
  description    text,
  display_order  integer not null default 0
);

comment on table vote_options is 'Available choices for a vote';

-- ============================================================
-- TABLE: participation_records
-- ============================================================
-- Tracks WHO voted on each vote, but NOT how they voted.
-- This is the "participation" side of the anonymous vote split.
-- Used for quorum checking, participation dashboards, and
-- targeting reminder emails at non-voters.
-- ============================================================

create table participation_records (
  id          uuid primary key default gen_random_uuid(),
  vote_id     uuid not null references votes(id) on delete cascade,
  member_id   uuid not null references members(id) on delete cascade,
  voted_at    timestamptz not null default now(),
  updated_at  timestamptz not null default now(),

  -- One participation record per member per vote
  constraint unique_participation unique (vote_id, member_id)
);

comment on table participation_records is 'Records that a member voted, without storing their choice';

-- ============================================================
-- TABLE: ballot_records_anonymous
-- ============================================================
-- Stores the CHOICE for anonymous votes with NO link to the voter.
-- There is deliberately no member_id column. The only link to a
-- specific vote is vote_id. Combined with participation_records,
-- you can count that the right number of ballots exist, but you
-- CANNOT match a ballot to a person.
--
-- For vote changes: the old ballot row is deleted and a new one
-- is inserted. Since there's no member_id, the app uses a
-- one-time token pattern (see Phase 6 implementation).
-- ============================================================

create table ballot_records_anonymous (
  id       uuid primary key default gen_random_uuid(),
  vote_id  uuid not null references votes(id) on delete cascade,
  choice   jsonb not null,
  cast_at  timestamptz not null default now()
);

comment on table ballot_records_anonymous is 'Anonymous ballot choices — deliberately has NO member_id';
comment on column ballot_records_anonymous.choice is 'JSON: {"option_id": "uuid"} for single choice, {"ranked": ["uuid", ...]} for ranked';

-- ============================================================
-- TABLE: ballot_records_named
-- ============================================================
-- Stores the CHOICE for admin-visible and open votes WITH a
-- link to the voter. Used when the vote's privacy_level is
-- 'admin_visible' or 'open'.
-- ============================================================

create table ballot_records_named (
  id         uuid primary key default gen_random_uuid(),
  vote_id    uuid not null references votes(id) on delete cascade,
  member_id  uuid not null references members(id) on delete cascade,
  choice     jsonb not null,
  cast_at    timestamptz not null default now(),

  -- One ballot per member per vote (updated in place on vote change)
  constraint unique_named_ballot unique (vote_id, member_id)
);

comment on table ballot_records_named is 'Named ballot choices for admin-visible and open votes';
comment on column ballot_records_named.choice is 'JSON: {"option_id": "uuid"} for single choice, {"ranked": ["uuid", ...]} for ranked';

-- ============================================================
-- TABLE: vote_proposals
-- ============================================================
-- Members can propose votes for admin review. If approved,
-- the admin creates the actual vote from the proposal data.
-- ============================================================

create table vote_proposals (
  id                          uuid primary key default gen_random_uuid(),
  proposed_by                 uuid not null references members(id),
  title                       text not null,
  description                 text,
  format                      vote_format not null,
  privacy_level               privacy_level not null default 'anonymous',
  options                     jsonb not null default '[]'::jsonb,
  quorum_percentage           integer not null default 75
                                check (quorum_percentage >= 0 and quorum_percentage <= 100),
  passing_threshold           passing_threshold not null default 'simple_majority',
  custom_threshold_percentage integer
                                check (custom_threshold_percentage is null
                                       or (custom_threshold_percentage > 0 and custom_threshold_percentage <= 100)),
  status                      proposal_status not null default 'pending',
  admin_notes                 text,
  created_at                  timestamptz not null default now(),
  reviewed_at                 timestamptz,

  constraint proposal_custom_threshold_required
    check (passing_threshold != 'custom' or custom_threshold_percentage is not null)
);

comment on table vote_proposals is 'Member-submitted vote proposals pending admin review';
comment on column vote_proposals.options is 'JSON array: [{"label": "...", "description": "..."}]';

-- ============================================================
-- INDEXES
-- ============================================================

-- Members: look up by email (login) and by auth_user_id (session resolution)
create index idx_members_email on members (email);
create index idx_members_auth_user_id on members (auth_user_id) where auth_user_id is not null;
create index idx_members_active on members (active) where active = true;

-- Votes: filter by status (dashboard queries), order by creation
create index idx_votes_status on votes (status);
create index idx_votes_created_by on votes (created_by);
create index idx_votes_deadline on votes (deadline) where deadline is not null;
create index idx_votes_status_created on votes (status, created_at desc);

-- Vote options: look up by vote
create index idx_vote_options_vote_id on vote_options (vote_id, display_order);

-- Participation: check if a member voted, count votes per member, count participation per vote
create index idx_participation_vote_id on participation_records (vote_id);
create index idx_participation_member_id on participation_records (member_id);

-- Anonymous ballots: count ballots per vote for tallying
create index idx_ballot_anonymous_vote_id on ballot_records_anonymous (vote_id);

-- Named ballots: look up a member's ballot, count ballots per vote
create index idx_ballot_named_vote_id on ballot_records_named (vote_id);
create index idx_ballot_named_member_id on ballot_records_named (member_id);

-- Proposals: filter by status (admin review queue)
create index idx_proposals_status on vote_proposals (status);
create index idx_proposals_proposed_by on vote_proposals (proposed_by);

-- ============================================================
-- UPDATED_AT TRIGGER
-- ============================================================

create or replace function update_updated_at()
returns trigger as $$
begin
  new.updated_at = now();
  return new;
end;
$$ language plpgsql;

create trigger members_updated_at
  before update on members
  for each row execute function update_updated_at();

create trigger participation_updated_at
  before update on participation_records
  for each row execute function update_updated_at();

-- ============================================================
-- ROW-LEVEL SECURITY (RLS) POLICIES
-- ============================================================

-- Enable RLS on all tables
alter table members enable row level security;
alter table votes enable row level security;
alter table vote_options enable row level security;
alter table participation_records enable row level security;
alter table ballot_records_anonymous enable row level security;
alter table ballot_records_named enable row level security;
alter table vote_proposals enable row level security;

-- -------------------------------------------------------
-- Helper function: get the current user's member record
-- -------------------------------------------------------
create or replace function get_current_member_id()
returns uuid as $$
  select id from members where auth_user_id = auth.uid() limit 1;
$$ language sql security definer stable;

create or replace function is_current_user_admin()
returns boolean as $$
  select exists (
    select 1 from members
    where auth_user_id = auth.uid()
      and role = 'admin'
      and active = true
  );
$$ language sql security definer stable;

-- -------------------------------------------------------
-- MEMBERS policies
-- -------------------------------------------------------

-- All authenticated members can read the member list (for displaying names)
create policy "Members: authenticated users can view active members"
  on members for select
  to authenticated
  using (active = true);

-- Admins can view ALL members (including inactive)
create policy "Members: admins can view all members"
  on members for select
  to authenticated
  using (is_current_user_admin());

-- Only admins can insert members (add to allowlist)
create policy "Members: admins can insert"
  on members for insert
  to authenticated
  with check (is_current_user_admin());

-- Only admins can update members (toggle active, change role)
create policy "Members: admins can update"
  on members for update
  to authenticated
  using (is_current_user_admin());

-- Members can update their own name
create policy "Members: users can update own name"
  on members for update
  to authenticated
  using (auth_user_id = auth.uid())
  with check (auth_user_id = auth.uid());

-- -------------------------------------------------------
-- VOTES policies
-- -------------------------------------------------------

-- Members can view open and closed votes
create policy "Votes: members can view open and closed"
  on votes for select
  to authenticated
  using (status in ('open', 'closed'));

-- Admins can view all votes (including drafts and pending_review)
create policy "Votes: admins can view all"
  on votes for select
  to authenticated
  using (is_current_user_admin());

-- Members can view their own drafts (proposals they created)
create policy "Votes: creators can view own drafts"
  on votes for select
  to authenticated
  using (created_by = get_current_member_id() and status = 'draft');

-- Only admins can create votes
create policy "Votes: admins can insert"
  on votes for insert
  to authenticated
  with check (is_current_user_admin());

-- Only admins can update votes (change status, edit config)
create policy "Votes: admins can update"
  on votes for update
  to authenticated
  using (is_current_user_admin());

-- -------------------------------------------------------
-- VOTE_OPTIONS policies
-- -------------------------------------------------------

-- Anyone authenticated can read options for votes they can see
create policy "Vote options: readable by authenticated users"
  on vote_options for select
  to authenticated
  using (
    exists (
      select 1 from votes
      where votes.id = vote_options.vote_id
        and (
          votes.status in ('open', 'closed')
          or is_current_user_admin()
        )
    )
  );

-- Only admins can manage options
create policy "Vote options: admins can insert"
  on vote_options for insert
  to authenticated
  with check (is_current_user_admin());

create policy "Vote options: admins can update"
  on vote_options for update
  to authenticated
  using (is_current_user_admin());

create policy "Vote options: admins can delete"
  on vote_options for delete
  to authenticated
  using (is_current_user_admin());

-- -------------------------------------------------------
-- PARTICIPATION_RECORDS policies
-- -------------------------------------------------------

-- Members can see participation for any vote (for the progress bar)
create policy "Participation: members can view"
  on participation_records for select
  to authenticated
  using (true);

-- Members can insert their own participation record
create policy "Participation: members can insert own"
  on participation_records for insert
  to authenticated
  with check (member_id = get_current_member_id());

-- Members can update their own participation record (updated_at on vote change)
create policy "Participation: members can update own"
  on participation_records for update
  to authenticated
  using (member_id = get_current_member_id());

-- -------------------------------------------------------
-- BALLOT_RECORDS_ANONYMOUS policies
-- -------------------------------------------------------
-- CRITICAL: These ballots must NOT be readable by anyone through
-- the API in a way that can be correlated with a user. They are
-- only accessed through server-side tallying functions.

-- No one can read anonymous ballots directly through the API.
-- Tallying is done via a server-side function using the service role key.
-- (No SELECT policy = no access through PostgREST / Supabase client)

-- Authenticated users can insert anonymous ballots (casting a vote).
-- The actual insert is done through a server action that ensures
-- the ballot cannot be traced back.
create policy "Anonymous ballots: insert via authenticated"
  on ballot_records_anonymous for insert
  to authenticated
  with check (true);

-- Deletion is handled server-side (service role) for vote changes.
-- No delete policy for regular users.

-- -------------------------------------------------------
-- BALLOT_RECORDS_NAMED policies
-- -------------------------------------------------------

-- For open votes: all members can see all ballots
create policy "Named ballots: open votes readable by all"
  on ballot_records_named for select
  to authenticated
  using (
    exists (
      select 1 from votes
      where votes.id = ballot_records_named.vote_id
        and votes.privacy_level = 'open'
        and votes.status = 'closed'
    )
  );

-- For admin-visible votes: admins can see ballots
create policy "Named ballots: admin-visible readable by admins"
  on ballot_records_named for select
  to authenticated
  using (
    is_current_user_admin()
    and exists (
      select 1 from votes
      where votes.id = ballot_records_named.vote_id
        and votes.privacy_level in ('admin_visible', 'open')
    )
  );

-- Members can see their own named ballots (to display "Your current vote")
create policy "Named ballots: members can view own"
  on ballot_records_named for select
  to authenticated
  using (member_id = get_current_member_id());

-- Members can insert their own named ballot
create policy "Named ballots: members can insert own"
  on ballot_records_named for insert
  to authenticated
  with check (member_id = get_current_member_id());

-- Members can update their own named ballot (vote change)
create policy "Named ballots: members can update own"
  on ballot_records_named for update
  to authenticated
  using (member_id = get_current_member_id());

-- -------------------------------------------------------
-- VOTE_PROPOSALS policies
-- -------------------------------------------------------

-- Members can view their own proposals
create policy "Proposals: members can view own"
  on vote_proposals for select
  to authenticated
  using (proposed_by = get_current_member_id());

-- Admins can view all proposals
create policy "Proposals: admins can view all"
  on vote_proposals for select
  to authenticated
  using (is_current_user_admin());

-- Members can create proposals
create policy "Proposals: members can insert"
  on vote_proposals for insert
  to authenticated
  with check (proposed_by = get_current_member_id());

-- Admins can update proposals (approve/reject, add notes)
create policy "Proposals: admins can update"
  on vote_proposals for update
  to authenticated
  using (is_current_user_admin());

-- Members can update their own pending proposals (edit before review)
create policy "Proposals: members can update own pending"
  on vote_proposals for update
  to authenticated
  using (proposed_by = get_current_member_id() and status = 'pending');
```

4. Verify the SQL is syntactically valid by running a dry check:

```bash
cd /Users/briantse/Projects/group-vote
npx supabase db lint --level warning
```

(If you have Supabase CLI linked to a project, you can also run `npx supabase db push --dry-run` to validate against a live instance.)

5. Commit:

```bash
git add supabase/
git commit -m "Add full database schema: tables, indexes, RLS policies, and triggers"
```

---

### Task 2.2 — Generate TypeScript Types from Schema

**Files:**
- `/Users/briantse/Projects/group-vote/src/lib/database.types.ts` (create/generate)

**Steps:**

1. If you have a running Supabase project linked, generate types automatically:

```bash
cd /Users/briantse/Projects/group-vote
npx supabase gen types typescript --linked > src/lib/database.types.ts
```

If no linked project yet, you can generate types from a local Supabase instance:

```bash
npx supabase start
npx supabase db push
npx supabase gen types typescript --local > src/lib/database.types.ts
npx supabase stop
```

Alternatively, if neither local nor linked Supabase is available yet, create a manual types file that mirrors the schema. The types in `src/lib/types.ts` (from Task 1.5) already cover the application layer. The generated `database.types.ts` adds Supabase-specific typing for `supabase.from('table').select()` calls. This can be generated later once Supabase is connected.

2. Commit:

```bash
git add src/lib/database.types.ts
git commit -m "Add generated Supabase TypeScript types"
```

---

### Task 2.3 — Seed Data for Development

**Files:**
- `/Users/briantse/Projects/group-vote/supabase/seed.sql` (create)

**Steps:**

1. Create a seed file with test data (an admin user and a few members):

```sql
-- supabase/seed.sql
-- Development seed data — do NOT run in production

-- Insert test members (auth_user_id will be linked after first magic-link login)
insert into members (email, name, role, active) values
  ('admin@example.com',   'Admin User',    'admin',  true),
  ('member1@example.com', 'Alice Johnson', 'member', true),
  ('member2@example.com', 'Bob Smith',     'member', true),
  ('member3@example.com', 'Carol Davis',   'member', true),
  ('member4@example.com', 'Dave Wilson',   'member', true),
  ('inactive@example.com','Eve Brown',     'member', false);
```

2. Apply seed data locally (if using local Supabase):

```bash
cd /Users/briantse/Projects/group-vote
npx supabase db reset
```

This runs all migrations and then the seed file.

3. Commit:

```bash
git add supabase/seed.sql
git commit -m "Add development seed data with test members"
```

---

## Phase 3: Authentication

### Task 3.1 — Magic Link Login Page

**Files:**
- `/Users/briantse/Projects/group-vote/src/app/(auth)/login/page.tsx` (replace placeholder)
- `/Users/briantse/Projects/group-vote/src/app/(auth)/login/actions.ts` (create)

**Steps:**

1. Create the server action for magic link login:

```ts
// src/app/(auth)/login/actions.ts
"use server";

import { createClient } from "@/lib/supabase/server";
import { createAdminClient } from "@/lib/supabase/admin";
import { redirect } from "next/navigation";

export interface LoginState {
  error: string | null;
  success: boolean;
}

export async function loginWithMagicLink(
  _prevState: LoginState,
  formData: FormData
): Promise<LoginState> {
  const email = formData.get("email") as string;

  if (!email || typeof email !== "string") {
    return { error: "Please enter your email address.", success: false };
  }

  const normalizedEmail = email.toLowerCase().trim();

  // Check the allowlist: is this email in the members table and active?
  const adminClient = createAdminClient();
  const { data: member, error: memberError } = await adminClient
    .from("members")
    .select("id, active")
    .eq("email", normalizedEmail)
    .single();

  if (memberError || !member) {
    return {
      error: "This email is not authorized. Contact your group admin.",
      success: false,
    };
  }

  if (!member.active) {
    return {
      error: "Your account is inactive. Contact your group admin.",
      success: false,
    };
  }

  // Send the magic link
  const supabase = await createClient();
  const { error: authError } = await supabase.auth.signInWithOtp({
    email: normalizedEmail,
    options: {
      emailRedirectTo: `${process.env.NEXT_PUBLIC_APP_URL}/auth/confirm`,
    },
  });

  if (authError) {
    return {
      error: "Failed to send login link. Please try again.",
      success: false,
    };
  }

  return { error: null, success: true };
}
```

2. Build the login page UI:

```tsx
// src/app/(auth)/login/page.tsx
"use client";

import { useActionState } from "react";
import { loginWithMagicLink, type LoginState } from "./actions";

const initialState: LoginState = { error: null, success: false };

export default function LoginPage() {
  const [state, formAction, isPending] = useActionState(
    loginWithMagicLink,
    initialState
  );

  return (
    <main className="flex min-h-screen items-center justify-center bg-gray-50 px-4">
      <div className="w-full max-w-md space-y-8">
        <div className="text-center">
          <h1 className="text-3xl font-bold tracking-tight text-gray-900">
            Group Vote
          </h1>
          <p className="mt-2 text-sm text-gray-600">
            Sign in with your group email to access voting
          </p>
        </div>

        {state.success ? (
          <div className="rounded-lg bg-green-50 p-6 text-center">
            <h2 className="text-lg font-semibold text-green-800">
              Check your email
            </h2>
            <p className="mt-2 text-sm text-green-700">
              We sent a login link to your email. Click it to sign in.
              The link expires in 15 minutes.
            </p>
          </div>
        ) : (
          <form action={formAction} className="space-y-6">
            {state.error && (
              <div className="rounded-lg bg-red-50 p-4 text-sm text-red-700">
                {state.error}
              </div>
            )}

            <div>
              <label
                htmlFor="email"
                className="block text-sm font-medium text-gray-700"
              >
                Email address
              </label>
              <input
                id="email"
                name="email"
                type="email"
                autoComplete="email"
                required
                className="mt-1 block w-full rounded-lg border border-gray-300 px-3 py-2 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500"
                placeholder="you@example.com"
              />
            </div>

            <button
              type="submit"
              disabled={isPending}
              className="w-full rounded-lg bg-blue-600 px-4 py-2.5 text-sm font-semibold text-white shadow-sm hover:bg-blue-500 disabled:opacity-50 disabled:cursor-not-allowed"
            >
              {isPending ? "Sending..." : "Send Login Link"}
            </button>
          </form>
        )}
      </div>
    </main>
  );
}
```

3. Verify the page renders:

```bash
cd /Users/briantse/Projects/group-vote
npm run dev
```

Visit `http://localhost:3000/login` and confirm the form renders.

4. Commit:

```bash
git add src/app/\(auth\)/login/
git commit -m "Implement magic link login page with email allowlist check"
```

---

### Task 3.2 — Auth Confirm Route (Magic Link Callback)

**Files:**
- `/Users/briantse/Projects/group-vote/src/app/(auth)/auth/confirm/route.ts` (replace placeholder)

**Steps:**

1. Implement the route handler that exchanges the magic link token for a session and links the auth user to the member record:

```ts
// src/app/(auth)/auth/confirm/route.ts
import { NextResponse, type NextRequest } from "next/server";
import { createServerClient } from "@supabase/ssr";
import { createAdminClient } from "@/lib/supabase/admin";

export async function GET(request: NextRequest) {
  const { searchParams } = new URL(request.url);
  const token_hash = searchParams.get("token_hash");
  const type = searchParams.get("type") as "magiclink" | "email" | null;
  const next = searchParams.get("next") ?? "/dashboard";

  const appUrl = process.env.NEXT_PUBLIC_APP_URL;
  if (!appUrl) {
    throw new Error("NEXT_PUBLIC_APP_URL environment variable is required");
  }

  const redirectTo = new URL(next, appUrl);

  if (!token_hash || !type) {
    redirectTo.pathname = "/login";
    redirectTo.searchParams.set("error", "Invalid login link");
    return NextResponse.redirect(redirectTo);
  }

  const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL;
  const supabaseAnonKey = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY;

  if (!supabaseUrl || !supabaseAnonKey) {
    throw new Error("Missing Supabase environment variables");
  }

  const response = NextResponse.redirect(redirectTo);

  const supabase = createServerClient(supabaseUrl, supabaseAnonKey, {
    cookies: {
      getAll() {
        return request.cookies.getAll();
      },
      setAll(cookiesToSet) {
        cookiesToSet.forEach(({ name, value, options }) =>
          response.cookies.set(name, value, options)
        );
      },
    },
  });

  const { data, error } = await supabase.auth.verifyOtp({
    token_hash,
    type: type === "magiclink" ? "magiclink" : "email",
  });

  if (error || !data.user) {
    redirectTo.pathname = "/login";
    redirectTo.searchParams.set("error", "Login link expired or invalid");
    return NextResponse.redirect(redirectTo);
  }

  // Link the Supabase auth user to the members table
  // This runs on every login to ensure the link is established
  const adminClient = createAdminClient();
  const { error: linkError } = await adminClient
    .from("members")
    .update({ auth_user_id: data.user.id })
    .eq("email", data.user.email!.toLowerCase())
    .is("auth_user_id", null);

  // linkError is non-fatal (might already be linked)
  if (linkError) {
    console.warn("Member link warning (may already be linked):", linkError.message);
  }

  return response;
}
```

2. Commit:

```bash
git add "src/app/(auth)/auth/confirm/route.ts"
git commit -m "Implement auth confirm route for magic link callback"
```

---

### Task 3.3 — Middleware for Protected Routes

**Files:**
- `/Users/briantse/Projects/group-vote/src/middleware.ts` (create)

**Steps:**

1. Create the Next.js middleware at the `src/` root:

```ts
// src/middleware.ts
import { type NextRequest, NextResponse } from "next/server";
import { updateSession } from "@/lib/supabase/middleware";
import { createServerClient } from "@supabase/ssr";

export async function middleware(request: NextRequest) {
  // First, refresh the session (handles token rotation)
  const response = await updateSession(request);

  const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL;
  const supabaseAnonKey = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY;

  if (!supabaseUrl || !supabaseAnonKey) {
    throw new Error("Missing Supabase environment variables");
  }

  // Check if the user is authenticated
  const supabase = createServerClient(supabaseUrl, supabaseAnonKey, {
    cookies: {
      getAll() {
        return request.cookies.getAll();
      },
      setAll() {
        // Cookies are already handled by updateSession above
      },
    },
  });

  const {
    data: { user },
  } = await supabase.auth.getUser();

  const { pathname } = request.nextUrl;

  // If user is NOT authenticated and tries to access a protected route
  if (!user && !pathname.startsWith("/login") && !pathname.startsWith("/auth")) {
    const loginUrl = new URL("/login", request.url);
    loginUrl.searchParams.set("next", pathname);
    return NextResponse.redirect(loginUrl);
  }

  // If user IS authenticated and tries to access the login page, redirect to dashboard
  if (user && pathname.startsWith("/login")) {
    return NextResponse.redirect(new URL("/dashboard", request.url));
  }

  return response;
}

export const config = {
  matcher: [
    /*
     * Match all request paths except:
     * - _next/static (static files)
     * - _next/image (image optimization)
     * - favicon.ico, sitemap.xml, robots.txt (metadata files)
     * - public assets
     */
    "/((?!_next/static|_next/image|favicon.ico|sitemap.xml|robots.txt|.*\\.(?:svg|png|jpg|jpeg|gif|webp)$).*)",
  ],
};
```

2. Verify the app still compiles:

```bash
cd /Users/briantse/Projects/group-vote
npm run build
```

3. Commit:

```bash
git add src/middleware.ts
git commit -m "Add authentication middleware for route protection"
```

---

### Task 3.4 — Session Helper and Auth Context

**Files:**
- `/Users/briantse/Projects/group-vote/src/lib/auth.ts` (create)
- `/Users/briantse/Projects/group-vote/src/app/(protected)/layout.tsx` (replace placeholder)

**Steps:**

1. Create an auth helper that retrieves the current member from the session (used in Server Components):

```ts
// src/lib/auth.ts
import { createClient } from "@/lib/supabase/server";
import { createAdminClient } from "@/lib/supabase/admin";
import { redirect } from "next/navigation";
import type { Member } from "@/lib/types";

/**
 * Get the currently authenticated member.
 * Must be called from a Server Component or Server Action.
 * Redirects to /login if not authenticated.
 */
export async function getCurrentMember(): Promise<Member> {
  const supabase = await createClient();
  const {
    data: { user },
  } = await supabase.auth.getUser();

  if (!user) {
    redirect("/login");
  }

  const adminClient = createAdminClient();
  const { data: member, error } = await adminClient
    .from("members")
    .select("*")
    .eq("auth_user_id", user.id)
    .single();

  if (error || !member) {
    // Auth user exists but no member record — force logout
    await supabase.auth.signOut();
    redirect("/login");
  }

  if (!member.active) {
    await supabase.auth.signOut();
    redirect("/login");
  }

  return member as Member;
}

/**
 * Require the current user to be an admin.
 * Redirects to /dashboard if not admin.
 */
export async function requireAdmin(): Promise<Member> {
  const member = await getCurrentMember();

  if (member.role !== "admin") {
    redirect("/dashboard");
  }

  return member;
}
```

2. Update the protected layout to pass the current member to child pages:

```tsx
// src/app/(protected)/layout.tsx
import { getCurrentMember } from "@/lib/auth";
import type { Member } from "@/lib/types";

export default async function ProtectedLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  const member = await getCurrentMember();

  return (
    <div className="min-h-screen bg-gray-50">
      <header className="border-b bg-white">
        <div className="mx-auto flex max-w-5xl items-center justify-between px-4 py-3">
          <a href="/dashboard" className="text-lg font-bold text-gray-900">
            Group Vote
          </a>
          <div className="flex items-center gap-4">
            {member.role === "admin" && (
              <a
                href="/admin/members"
                className="text-sm text-gray-600 hover:text-gray-900"
              >
                Admin
              </a>
            )}
            <span className="text-sm text-gray-500">{member.email}</span>
            <form action="/auth/signout" method="post">
              <button
                type="submit"
                className="text-sm text-gray-500 hover:text-gray-900"
              >
                Sign out
              </button>
            </form>
          </div>
        </div>
      </header>
      <main className="mx-auto max-w-5xl px-4 py-6">{children}</main>
    </div>
  );
}
```

3. Create a sign-out route:

Create the file `/Users/briantse/Projects/group-vote/src/app/(auth)/auth/signout/route.ts`:

```ts
// src/app/(auth)/auth/signout/route.ts
import { createClient } from "@/lib/supabase/server";
import { NextResponse, type NextRequest } from "next/server";

export async function POST(request: NextRequest) {
  const supabase = await createClient();
  await supabase.auth.signOut();

  const appUrl = process.env.NEXT_PUBLIC_APP_URL;
  if (!appUrl) {
    throw new Error("NEXT_PUBLIC_APP_URL environment variable is required");
  }

  return NextResponse.redirect(new URL("/login", appUrl), { status: 302 });
}
```

4. Commit:

```bash
git add src/lib/auth.ts "src/app/(protected)/layout.tsx" "src/app/(auth)/auth/signout/"
git commit -m "Add session helpers, protected layout with nav, and sign-out route"
```

---

## Phase 4: Admin Member Management

### Task 4.1 — Member List Page (Admin)

**Files:**
- `/Users/briantse/Projects/group-vote/src/app/(protected)/admin/members/page.tsx` (replace placeholder)

**Steps:**

1. Build the admin members page that lists all members with their status:

```tsx
// src/app/(protected)/admin/members/page.tsx
import { requireAdmin } from "@/lib/auth";
import { createAdminClient } from "@/lib/supabase/admin";
import { AddMemberForm } from "./add-member-form";
import { MemberRow } from "./member-row";

export default async function AdminMembersPage() {
  await requireAdmin();

  const adminClient = createAdminClient();
  const { data: members, error } = await adminClient
    .from("members")
    .select("*")
    .order("name", { ascending: true });

  if (error) {
    throw new Error(`Failed to load members: ${error.message}`);
  }

  const activeCount = members.filter((m) => m.active).length;

  return (
    <div className="space-y-6">
      <div>
        <h1 className="text-2xl font-bold text-gray-900">Manage Members</h1>
        <p className="mt-1 text-sm text-gray-500">
          {activeCount} active member{activeCount !== 1 ? "s" : ""} of{" "}
          {members.length} total
        </p>
      </div>

      <AddMemberForm />

      <div className="overflow-hidden rounded-lg border bg-white shadow-sm">
        <table className="min-w-full divide-y divide-gray-200">
          <thead className="bg-gray-50">
            <tr>
              <th className="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500">
                Name
              </th>
              <th className="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500">
                Email
              </th>
              <th className="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500">
                Role
              </th>
              <th className="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500">
                Status
              </th>
              <th className="px-4 py-3 text-right text-xs font-medium uppercase tracking-wider text-gray-500">
                Actions
              </th>
            </tr>
          </thead>
          <tbody className="divide-y divide-gray-200">
            {members.map((member) => (
              <MemberRow key={member.id} member={member} />
            ))}
          </tbody>
        </table>
      </div>
    </div>
  );
}
```

2. Commit after implementing the sub-components (see Tasks 4.2 and 4.3).

---

### Task 4.2 — Add Member Form

**Files:**
- `/Users/briantse/Projects/group-vote/src/app/(protected)/admin/members/add-member-form.tsx` (create)
- `/Users/briantse/Projects/group-vote/src/app/(protected)/admin/members/actions.ts` (create)

**Steps:**

1. Create the server actions for member management:

```ts
// src/app/(protected)/admin/members/actions.ts
"use server";

import { requireAdmin } from "@/lib/auth";
import { createAdminClient } from "@/lib/supabase/admin";
import { revalidatePath } from "next/cache";

export interface AddMemberState {
  error: string | null;
  success: boolean;
}

export async function addMember(
  _prevState: AddMemberState,
  formData: FormData
): Promise<AddMemberState> {
  await requireAdmin();

  const email = (formData.get("email") as string)?.toLowerCase().trim();
  const name = (formData.get("name") as string)?.trim() || null;

  if (!email) {
    return { error: "Email is required.", success: false };
  }

  // Basic email validation
  const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  if (!emailRegex.test(email)) {
    return { error: "Please enter a valid email address.", success: false };
  }

  const adminClient = createAdminClient();

  // Check if email already exists
  const { data: existing } = await adminClient
    .from("members")
    .select("id, active")
    .eq("email", email)
    .single();

  if (existing) {
    if (!existing.active) {
      // Reactivate the member
      const { error } = await adminClient
        .from("members")
        .update({ active: true, name: name ?? undefined })
        .eq("id", existing.id);

      if (error) {
        return { error: `Failed to reactivate member: ${error.message}`, success: false };
      }

      revalidatePath("/admin/members");
      return { error: null, success: true };
    }
    return { error: "This email is already on the member list.", success: false };
  }

  // Insert new member
  const { error } = await adminClient
    .from("members")
    .insert({ email, name });

  if (error) {
    return { error: `Failed to add member: ${error.message}`, success: false };
  }

  revalidatePath("/admin/members");
  return { error: null, success: true };
}

export async function toggleMemberActive(memberId: string, active: boolean) {
  await requireAdmin();

  const adminClient = createAdminClient();
  const { error } = await adminClient
    .from("members")
    .update({ active })
    .eq("id", memberId);

  if (error) {
    throw new Error(`Failed to update member: ${error.message}`);
  }

  revalidatePath("/admin/members");
}

export async function removeMember(memberId: string) {
  await requireAdmin();

  const adminClient = createAdminClient();

  // Check if member has any participation records — if so, deactivate instead of delete
  const { count } = await adminClient
    .from("participation_records")
    .select("*", { count: "exact", head: true })
    .eq("member_id", memberId);

  if (count && count > 0) {
    // Has voting history — deactivate to preserve records
    const { error } = await adminClient
      .from("members")
      .update({ active: false })
      .eq("id", memberId);

    if (error) {
      throw new Error(`Failed to deactivate member: ${error.message}`);
    }
  } else {
    // No history — safe to delete entirely
    const { error } = await adminClient
      .from("members")
      .delete()
      .eq("id", memberId);

    if (error) {
      throw new Error(`Failed to remove member: ${error.message}`);
    }
  }

  revalidatePath("/admin/members");
}
```

2. Create the add member form component:

```tsx
// src/app/(protected)/admin/members/add-member-form.tsx
"use client";

import { useActionState, useRef } from "react";
import { addMember, type AddMemberState } from "./actions";

const initialState: AddMemberState = { error: null, success: false };

export function AddMemberForm() {
  const [state, formAction, isPending] = useActionState(addMember, initialState);
  const formRef = useRef<HTMLFormElement>(null);

  // Reset form on success
  if (state.success && formRef.current) {
    formRef.current.reset();
  }

  return (
    <div className="rounded-lg border bg-white p-4 shadow-sm">
      <h2 className="text-sm font-semibold text-gray-900">Add Member</h2>
      <form ref={formRef} action={formAction} className="mt-3 flex gap-3">
        <input
          name="name"
          type="text"
          placeholder="Name (optional)"
          className="w-48 rounded-lg border border-gray-300 px-3 py-2 text-sm focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500"
        />
        <input
          name="email"
          type="email"
          required
          placeholder="email@example.com"
          className="flex-1 rounded-lg border border-gray-300 px-3 py-2 text-sm focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500"
        />
        <button
          type="submit"
          disabled={isPending}
          className="rounded-lg bg-blue-600 px-4 py-2 text-sm font-semibold text-white hover:bg-blue-500 disabled:opacity-50"
        >
          {isPending ? "Adding..." : "Add"}
        </button>
      </form>
      {state.error && (
        <p className="mt-2 text-sm text-red-600">{state.error}</p>
      )}
      {state.success && (
        <p className="mt-2 text-sm text-green-600">Member added successfully.</p>
      )}
    </div>
  );
}
```

3. Commit (combined with Task 4.3).

---

### Task 4.3 — Member Row with Toggle and Remove

**Files:**
- `/Users/briantse/Projects/group-vote/src/app/(protected)/admin/members/member-row.tsx` (create)

**Steps:**

1. Create the member row component with toggle and remove actions:

```tsx
// src/app/(protected)/admin/members/member-row.tsx
"use client";

import { useTransition } from "react";
import { toggleMemberActive, removeMember } from "./actions";
import type { Member } from "@/lib/types";

export function MemberRow({ member }: { member: Member }) {
  const [isPending, startTransition] = useTransition();

  function handleToggle() {
    startTransition(() => {
      toggleMemberActive(member.id, !member.active);
    });
  }

  function handleRemove() {
    if (!confirm(`Remove ${member.email} from the group?`)) return;
    startTransition(() => {
      removeMember(member.id);
    });
  }

  return (
    <tr className={isPending ? "opacity-50" : ""}>
      <td className="whitespace-nowrap px-4 py-3 text-sm text-gray-900">
        {member.name || "—"}
      </td>
      <td className="whitespace-nowrap px-4 py-3 text-sm text-gray-500">
        {member.email}
      </td>
      <td className="whitespace-nowrap px-4 py-3 text-sm">
        <span
          className={
            member.role === "admin"
              ? "inline-flex rounded-full bg-purple-100 px-2 py-0.5 text-xs font-medium text-purple-800"
              : "inline-flex rounded-full bg-gray-100 px-2 py-0.5 text-xs font-medium text-gray-800"
          }
        >
          {member.role}
        </span>
      </td>
      <td className="whitespace-nowrap px-4 py-3 text-sm">
        <span
          className={
            member.active
              ? "inline-flex rounded-full bg-green-100 px-2 py-0.5 text-xs font-medium text-green-800"
              : "inline-flex rounded-full bg-red-100 px-2 py-0.5 text-xs font-medium text-red-800"
          }
        >
          {member.active ? "Active" : "Inactive"}
        </span>
      </td>
      <td className="whitespace-nowrap px-4 py-3 text-right text-sm">
        <button
          onClick={handleToggle}
          disabled={isPending}
          className="mr-2 text-blue-600 hover:text-blue-800 disabled:opacity-50"
        >
          {member.active ? "Deactivate" : "Activate"}
        </button>
        <button
          onClick={handleRemove}
          disabled={isPending}
          className="text-red-600 hover:text-red-800 disabled:opacity-50"
        >
          Remove
        </button>
      </td>
    </tr>
  );
}
```

2. Verify the admin members page renders:

```bash
cd /Users/briantse/Projects/group-vote
npm run build
```

3. Commit:

```bash
git add "src/app/(protected)/admin/members/"
git commit -m "Implement admin member management: list, add, toggle active, remove"
```

---

## Phase 5: Vote Creation (Admin)

### Task 5.1 — Vote List Page

**Files:**
- `/Users/briantse/Projects/group-vote/src/app/(protected)/admin/votes/page.tsx` (replace placeholder)

**Steps:**

1. Build the admin vote list page showing all votes with status badges:

```tsx
// src/app/(protected)/admin/votes/page.tsx
import { requireAdmin } from "@/lib/auth";
import { createAdminClient } from "@/lib/supabase/admin";
import {
  VOTE_FORMAT_LABELS,
  PRIVACY_LEVEL_LABELS,
} from "@/lib/constants";
import type { Vote } from "@/lib/types";

const STATUS_STYLES: Record<string, string> = {
  draft: "bg-gray-100 text-gray-800",
  pending_review: "bg-yellow-100 text-yellow-800",
  open: "bg-green-100 text-green-800",
  closed: "bg-blue-100 text-blue-800",
};

export default async function AdminVotesPage() {
  await requireAdmin();

  const adminClient = createAdminClient();
  const { data: votes, error } = await adminClient
    .from("votes")
    .select("*")
    .order("created_at", { ascending: false });

  if (error) {
    throw new Error(`Failed to load votes: ${error.message}`);
  }

  return (
    <div className="space-y-6">
      <div className="flex items-center justify-between">
        <div>
          <h1 className="text-2xl font-bold text-gray-900">Manage Votes</h1>
          <p className="mt-1 text-sm text-gray-500">
            {votes.length} vote{votes.length !== 1 ? "s" : ""} total
          </p>
        </div>
        <a
          href="/votes/new"
          className="rounded-lg bg-blue-600 px-4 py-2 text-sm font-semibold text-white shadow-sm hover:bg-blue-500"
        >
          Create Vote
        </a>
      </div>

      {votes.length === 0 ? (
        <div className="rounded-lg border bg-white p-8 text-center text-gray-500">
          No votes yet. Create the first one.
        </div>
      ) : (
        <div className="space-y-3">
          {votes.map((vote: Vote) => (
            <div
              key={vote.id}
              className="flex items-center justify-between rounded-lg border bg-white px-4 py-3 shadow-sm"
            >
              <div>
                <a
                  href={`/votes/${vote.id}`}
                  className="font-medium text-gray-900 hover:text-blue-600"
                >
                  {vote.title}
                </a>
                <div className="mt-1 flex gap-3 text-xs text-gray-500">
                  <span>{VOTE_FORMAT_LABELS[vote.format]}</span>
                  <span>{PRIVACY_LEVEL_LABELS[vote.privacy_level]}</span>
                  {vote.deadline && (
                    <span>
                      Deadline:{" "}
                      {new Date(vote.deadline).toLocaleDateString()}
                    </span>
                  )}
                </div>
              </div>
              <span
                className={`inline-flex rounded-full px-2 py-0.5 text-xs font-medium ${
                  STATUS_STYLES[vote.status] || STATUS_STYLES.draft
                }`}
              >
                {vote.status.replace("_", " ")}
              </span>
            </div>
          ))}
        </div>
      )}
    </div>
  );
}
```

2. Commit (combined with Tasks 5.2 and 5.3).

---

### Task 5.2 — Vote Creation Server Action

**Files:**
- `/Users/briantse/Projects/group-vote/src/app/(protected)/votes/new/actions.ts` (create)

**Steps:**

1. Create the server action to handle vote creation:

```ts
// src/app/(protected)/votes/new/actions.ts
"use server";

import { requireAdmin } from "@/lib/auth";
import { createAdminClient } from "@/lib/supabase/admin";
import { redirect } from "next/navigation";
import type { VoteFormat, PrivacyLevel, PassingThreshold } from "@/lib/types";

export interface CreateVoteState {
  error: string | null;
  fieldErrors: Record<string, string>;
}

export async function createVote(
  _prevState: CreateVoteState,
  formData: FormData
): Promise<CreateVoteState> {
  const member = await requireAdmin();

  // Extract form values
  const title = (formData.get("title") as string)?.trim();
  const description = (formData.get("description") as string)?.trim() || null;
  const format = formData.get("format") as VoteFormat;
  const privacyLevel = formData.get("privacy_level") as PrivacyLevel;
  const quorumPercentage = parseInt(formData.get("quorum_percentage") as string, 10);
  const passingThreshold = formData.get("passing_threshold") as PassingThreshold;
  const customThresholdPercentage = formData.get("custom_threshold_percentage")
    ? parseInt(formData.get("custom_threshold_percentage") as string, 10)
    : null;
  const deadlineStr = (formData.get("deadline") as string) || null;

  // Parse options from form (dynamic fields: option_label_0, option_label_1, etc.)
  const options: { label: string; description: string | null }[] = [];
  let i = 0;
  while (formData.has(`option_label_${i}`)) {
    const label = (formData.get(`option_label_${i}`) as string)?.trim();
    const optDesc =
      (formData.get(`option_description_${i}`) as string)?.trim() || null;
    if (label) {
      options.push({ label, description: optDesc });
    }
    i++;
  }

  // Validation
  const fieldErrors: Record<string, string> = {};

  if (!title) fieldErrors.title = "Title is required.";
  if (!format) fieldErrors.format = "Vote format is required.";
  if (!privacyLevel) fieldErrors.privacy_level = "Privacy level is required.";
  if (isNaN(quorumPercentage) || quorumPercentage < 0 || quorumPercentage > 100) {
    fieldErrors.quorum_percentage = "Quorum must be between 0 and 100.";
  }
  if (!passingThreshold) fieldErrors.passing_threshold = "Passing threshold is required.";
  if (
    passingThreshold === "custom" &&
    (customThresholdPercentage === null ||
      customThresholdPercentage <= 0 ||
      customThresholdPercentage > 100)
  ) {
    fieldErrors.custom_threshold_percentage =
      "Custom threshold must be between 1 and 100.";
  }

  // For yes/no, auto-create options; for others, require at least 2
  if (format === "yes_no") {
    // Auto-populate
  } else if (options.length < 2) {
    fieldErrors.options = "At least 2 options are required.";
  }

  if (format === "ranked_choice" && options.length < 3) {
    fieldErrors.options = "Ranked choice requires at least 3 options.";
  }

  if (Object.keys(fieldErrors).length > 0) {
    return { error: "Please fix the errors below.", fieldErrors };
  }

  const adminClient = createAdminClient();

  // Insert the vote
  const { data: vote, error: voteError } = await adminClient
    .from("votes")
    .insert({
      title,
      description,
      format,
      privacy_level: privacyLevel,
      status: "draft",
      quorum_percentage: quorumPercentage,
      passing_threshold: passingThreshold,
      custom_threshold_percentage:
        passingThreshold === "custom" ? customThresholdPercentage : null,
      deadline: deadlineStr ? new Date(deadlineStr).toISOString() : null,
      created_by: member.id,
    })
    .select("id")
    .single();

  if (voteError || !vote) {
    return {
      error: `Failed to create vote: ${voteError?.message || "Unknown error"}`,
      fieldErrors: {},
    };
  }

  // Insert options
  const optionsToInsert =
    format === "yes_no"
      ? [
          { vote_id: vote.id, label: "Yes", display_order: 0 },
          { vote_id: vote.id, label: "No", display_order: 1 },
        ]
      : options.map((opt, idx) => ({
          vote_id: vote.id,
          label: opt.label,
          description: opt.description,
          display_order: idx,
        }));

  const { error: optionsError } = await adminClient
    .from("vote_options")
    .insert(optionsToInsert);

  if (optionsError) {
    // Clean up the vote if options failed
    await adminClient.from("votes").delete().eq("id", vote.id);
    return {
      error: `Failed to create vote options: ${optionsError.message}`,
      fieldErrors: {},
    };
  }

  redirect(`/votes/${vote.id}`);
}
```

2. Commit (combined with Task 5.3).

---

### Task 5.3 — Vote Creation Form Page

**Files:**
- `/Users/briantse/Projects/group-vote/src/app/(protected)/votes/new/page.tsx` (replace placeholder)
- `/Users/briantse/Projects/group-vote/src/app/(protected)/votes/new/vote-form.tsx` (create)

**Steps:**

1. Create the vote creation form client component with dynamic option fields:

```tsx
// src/app/(protected)/votes/new/vote-form.tsx
"use client";

import { useActionState, useState } from "react";
import { createVote, type CreateVoteState } from "./actions";
import {
  VOTE_FORMAT_LABELS,
  PRIVACY_LEVEL_LABELS,
  PASSING_THRESHOLD_LABELS,
  QUORUM_DEFAULT,
} from "@/lib/constants";
import type { VoteFormat } from "@/lib/types";

const initialState: CreateVoteState = { error: null, fieldErrors: {} };

export function VoteForm() {
  const [state, formAction, isPending] = useActionState(createVote, initialState);
  const [format, setFormat] = useState<VoteFormat>("yes_no");
  const [showCustomThreshold, setShowCustomThreshold] = useState(false);
  const [options, setOptions] = useState([
    { label: "", description: "" },
    { label: "", description: "" },
  ]);

  function addOption() {
    setOptions([...options, { label: "", description: "" }]);
  }

  function removeOption(index: number) {
    if (options.length <= 2) return;
    setOptions(options.filter((_, i) => i !== index));
  }

  const showOptions = format !== "yes_no";

  return (
    <form action={formAction} className="space-y-6">
      {state.error && (
        <div className="rounded-lg bg-red-50 p-4 text-sm text-red-700">
          {state.error}
        </div>
      )}

      {/* Title */}
      <div>
        <label htmlFor="title" className="block text-sm font-medium text-gray-700">
          Title *
        </label>
        <input
          id="title"
          name="title"
          type="text"
          required
          className="mt-1 block w-full rounded-lg border border-gray-300 px-3 py-2 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500"
          placeholder="e.g., Approve 2026 call schedule policy"
        />
        {state.fieldErrors.title && (
          <p className="mt-1 text-sm text-red-600">{state.fieldErrors.title}</p>
        )}
      </div>

      {/* Description */}
      <div>
        <label htmlFor="description" className="block text-sm font-medium text-gray-700">
          Description
        </label>
        <textarea
          id="description"
          name="description"
          rows={3}
          className="mt-1 block w-full rounded-lg border border-gray-300 px-3 py-2 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500"
          placeholder="Provide context for voters..."
        />
      </div>

      {/* Format */}
      <div>
        <label htmlFor="format" className="block text-sm font-medium text-gray-700">
          Vote Format *
        </label>
        <select
          id="format"
          name="format"
          value={format}
          onChange={(e) => setFormat(e.target.value as VoteFormat)}
          className="mt-1 block w-full rounded-lg border border-gray-300 px-3 py-2 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500"
        >
          {Object.entries(VOTE_FORMAT_LABELS).map(([value, label]) => (
            <option key={value} value={value}>
              {label}
            </option>
          ))}
        </select>
        {state.fieldErrors.format && (
          <p className="mt-1 text-sm text-red-600">{state.fieldErrors.format}</p>
        )}
      </div>

      {/* Options (only for multiple_choice and ranked_choice) */}
      {showOptions && (
        <div>
          <label className="block text-sm font-medium text-gray-700">
            Options *
          </label>
          <div className="mt-2 space-y-3">
            {options.map((opt, idx) => (
              <div key={idx} className="flex gap-2">
                <div className="flex-1">
                  <input
                    name={`option_label_${idx}`}
                    type="text"
                    required
                    placeholder={`Option ${idx + 1}`}
                    defaultValue={opt.label}
                    className="block w-full rounded-lg border border-gray-300 px-3 py-2 text-sm shadow-sm focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500"
                  />
                </div>
                <div className="flex-1">
                  <input
                    name={`option_description_${idx}`}
                    type="text"
                    placeholder="Description (optional)"
                    defaultValue={opt.description}
                    className="block w-full rounded-lg border border-gray-300 px-3 py-2 text-sm shadow-sm focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500"
                  />
                </div>
                {options.length > 2 && (
                  <button
                    type="button"
                    onClick={() => removeOption(idx)}
                    className="rounded-lg px-2 py-2 text-sm text-red-600 hover:bg-red-50"
                  >
                    Remove
                  </button>
                )}
              </div>
            ))}
          </div>
          <button
            type="button"
            onClick={addOption}
            className="mt-2 text-sm font-medium text-blue-600 hover:text-blue-800"
          >
            + Add option
          </button>
          {state.fieldErrors.options && (
            <p className="mt-1 text-sm text-red-600">{state.fieldErrors.options}</p>
          )}
        </div>
      )}

      {/* Privacy Level */}
      <div>
        <label htmlFor="privacy_level" className="block text-sm font-medium text-gray-700">
          Privacy Level *
        </label>
        <select
          id="privacy_level"
          name="privacy_level"
          defaultValue="anonymous"
          className="mt-1 block w-full rounded-lg border border-gray-300 px-3 py-2 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500"
        >
          {Object.entries(PRIVACY_LEVEL_LABELS).map(([value, label]) => (
            <option key={value} value={value}>
              {label}
            </option>
          ))}
        </select>
        <p className="mt-1 text-xs text-gray-500">
          Anonymous: no one can see who voted how. Admin-Visible: only admin sees
          individual votes. Open: everyone sees.
        </p>
      </div>

      {/* Quorum */}
      <div>
        <label htmlFor="quorum_percentage" className="block text-sm font-medium text-gray-700">
          Quorum (% of members who must vote) *
        </label>
        <input
          id="quorum_percentage"
          name="quorum_percentage"
          type="number"
          min={0}
          max={100}
          defaultValue={QUORUM_DEFAULT}
          className="mt-1 block w-32 rounded-lg border border-gray-300 px-3 py-2 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500"
        />
        {state.fieldErrors.quorum_percentage && (
          <p className="mt-1 text-sm text-red-600">
            {state.fieldErrors.quorum_percentage}
          </p>
        )}
      </div>

      {/* Passing Threshold */}
      <div>
        <label
          htmlFor="passing_threshold"
          className="block text-sm font-medium text-gray-700"
        >
          Passing Threshold *
        </label>
        <select
          id="passing_threshold"
          name="passing_threshold"
          defaultValue="simple_majority"
          onChange={(e) =>
            setShowCustomThreshold(e.target.value === "custom")
          }
          className="mt-1 block w-full rounded-lg border border-gray-300 px-3 py-2 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500"
        >
          {Object.entries(PASSING_THRESHOLD_LABELS).map(([value, label]) => (
            <option key={value} value={value}>
              {label}
            </option>
          ))}
        </select>
        {state.fieldErrors.passing_threshold && (
          <p className="mt-1 text-sm text-red-600">
            {state.fieldErrors.passing_threshold}
          </p>
        )}
      </div>

      {/* Custom Threshold Percentage */}
      {showCustomThreshold && (
        <div>
          <label
            htmlFor="custom_threshold_percentage"
            className="block text-sm font-medium text-gray-700"
          >
            Custom Threshold (%) *
          </label>
          <input
            id="custom_threshold_percentage"
            name="custom_threshold_percentage"
            type="number"
            min={1}
            max={100}
            required
            className="mt-1 block w-32 rounded-lg border border-gray-300 px-3 py-2 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500"
          />
          {state.fieldErrors.custom_threshold_percentage && (
            <p className="mt-1 text-sm text-red-600">
              {state.fieldErrors.custom_threshold_percentage}
            </p>
          )}
        </div>
      )}

      {/* Deadline */}
      <div>
        <label htmlFor="deadline" className="block text-sm font-medium text-gray-700">
          Deadline (optional)
        </label>
        <input
          id="deadline"
          name="deadline"
          type="datetime-local"
          className="mt-1 block w-64 rounded-lg border border-gray-300 px-3 py-2 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500"
        />
        <p className="mt-1 text-xs text-gray-500">
          Leave blank for open-ended votes (admin closes manually).
        </p>
      </div>

      {/* Submit */}
      <div className="flex gap-3 border-t pt-6">
        <button
          type="submit"
          disabled={isPending}
          className="rounded-lg bg-blue-600 px-6 py-2.5 text-sm font-semibold text-white shadow-sm hover:bg-blue-500 disabled:opacity-50"
        >
          {isPending ? "Creating..." : "Create Vote"}
        </button>
        <a
          href="/admin/votes"
          className="rounded-lg border border-gray-300 px-6 py-2.5 text-sm font-semibold text-gray-700 shadow-sm hover:bg-gray-50"
        >
          Cancel
        </a>
      </div>
    </form>
  );
}
```

2. Create the page wrapper:

```tsx
// src/app/(protected)/votes/new/page.tsx
import { requireAdmin } from "@/lib/auth";
import { VoteForm } from "./vote-form";

export default async function NewVotePage() {
  await requireAdmin();

  return (
    <div className="mx-auto max-w-2xl space-y-6">
      <div>
        <h1 className="text-2xl font-bold text-gray-900">Create a Vote</h1>
        <p className="mt-1 text-sm text-gray-500">
          Configure the vote settings. It will be saved as a draft until you
          open it for voting.
        </p>
      </div>
      <VoteForm />
    </div>
  );
}
```

3. Verify the full app compiles:

```bash
cd /Users/briantse/Projects/group-vote
npm run build
```

4. Commit:

```bash
git add "src/app/(protected)/admin/votes/" "src/app/(protected)/votes/new/"
git commit -m "Implement vote creation: admin list page, creation form with all config options"
```

---

### Task 5.4 — Basic Vote Detail Page (Read-Only)

**Files:**
- `/Users/briantse/Projects/group-vote/src/app/(protected)/votes/[id]/page.tsx` (replace placeholder)

**Steps:**

1. Build a read-only vote detail page that shows vote configuration and options. This will be expanded later with ballot casting in Phase 6:

```tsx
// src/app/(protected)/votes/[id]/page.tsx
import { getCurrentMember } from "@/lib/auth";
import { createAdminClient } from "@/lib/supabase/admin";
import {
  VOTE_FORMAT_LABELS,
  PRIVACY_LEVEL_LABELS,
  PASSING_THRESHOLD_LABELS,
} from "@/lib/constants";
import { notFound } from "next/navigation";
import type { Vote, VoteOption } from "@/lib/types";

interface Props {
  params: Promise<{ id: string }>;
}

export default async function VoteDetailPage({ params }: Props) {
  const { id } = await params;
  const member = await getCurrentMember();
  const adminClient = createAdminClient();

  // Fetch vote
  const { data: vote, error: voteError } = await adminClient
    .from("votes")
    .select("*")
    .eq("id", id)
    .single();

  if (voteError || !vote) {
    notFound();
  }

  // Non-admins cannot see drafts or pending_review votes
  if (
    member.role !== "admin" &&
    !["open", "closed"].includes(vote.status)
  ) {
    notFound();
  }

  // Fetch options
  const { data: options } = await adminClient
    .from("vote_options")
    .select("*")
    .eq("vote_id", id)
    .order("display_order");

  // Fetch participation count
  const { count: participationCount } = await adminClient
    .from("participation_records")
    .select("*", { count: "exact", head: true })
    .eq("vote_id", id);

  // Fetch total active members for quorum calculation
  const { count: totalMembers } = await adminClient
    .from("members")
    .select("*", { count: "exact", head: true })
    .eq("active", true);

  const typedVote = vote as Vote;
  const typedOptions = (options || []) as VoteOption[];

  return (
    <div className="mx-auto max-w-2xl space-y-6">
      {/* Header */}
      <div>
        <div className="flex items-center gap-3">
          <h1 className="text-2xl font-bold text-gray-900">{typedVote.title}</h1>
          <span className="inline-flex rounded-full bg-gray-100 px-2 py-0.5 text-xs font-medium text-gray-800">
            {typedVote.status.replace("_", " ")}
          </span>
        </div>
        {typedVote.description && (
          <p className="mt-2 text-gray-600">{typedVote.description}</p>
        )}
      </div>

      {/* Configuration Summary */}
      <div className="rounded-lg border bg-white p-4 shadow-sm">
        <h2 className="text-sm font-semibold text-gray-900">Vote Configuration</h2>
        <dl className="mt-3 grid grid-cols-2 gap-x-4 gap-y-2 text-sm">
          <dt className="text-gray-500">Format</dt>
          <dd className="text-gray-900">{VOTE_FORMAT_LABELS[typedVote.format]}</dd>

          <dt className="text-gray-500">Privacy</dt>
          <dd className="text-gray-900">
            {PRIVACY_LEVEL_LABELS[typedVote.privacy_level]}
          </dd>

          <dt className="text-gray-500">Quorum</dt>
          <dd className="text-gray-900">{typedVote.quorum_percentage}%</dd>

          <dt className="text-gray-500">Threshold</dt>
          <dd className="text-gray-900">
            {PASSING_THRESHOLD_LABELS[typedVote.passing_threshold]}
            {typedVote.custom_threshold_percentage &&
              ` (${typedVote.custom_threshold_percentage}%)`}
          </dd>

          <dt className="text-gray-500">Deadline</dt>
          <dd className="text-gray-900">
            {typedVote.deadline
              ? new Date(typedVote.deadline).toLocaleString()
              : "Open-ended (admin closes)"}
          </dd>
        </dl>
      </div>

      {/* Participation Progress */}
      {typedVote.status === "open" && (
        <div className="rounded-lg border bg-white p-4 shadow-sm">
          <h2 className="text-sm font-semibold text-gray-900">Participation</h2>
          <div className="mt-2">
            <div className="flex justify-between text-sm">
              <span className="text-gray-600">
                {participationCount ?? 0} of {totalMembers ?? 0} have voted
              </span>
              <span className="text-gray-500">
                {totalMembers
                  ? Math.round(
                      ((participationCount ?? 0) / totalMembers) * 100
                    )
                  : 0}
                %
              </span>
            </div>
            <div className="mt-1 h-2 w-full overflow-hidden rounded-full bg-gray-200">
              <div
                className="h-2 rounded-full bg-blue-600 transition-all"
                style={{
                  width: `${
                    totalMembers
                      ? Math.round(
                          ((participationCount ?? 0) / totalMembers) * 100
                        )
                      : 0
                  }%`,
                }}
              />
            </div>
          </div>
        </div>
      )}

      {/* Options */}
      <div className="rounded-lg border bg-white p-4 shadow-sm">
        <h2 className="text-sm font-semibold text-gray-900">Options</h2>
        <ul className="mt-3 space-y-2">
          {typedOptions.map((option) => (
            <li
              key={option.id}
              className="rounded-lg border border-gray-200 px-4 py-3"
            >
              <span className="font-medium text-gray-900">{option.label}</span>
              {option.description && (
                <p className="mt-1 text-sm text-gray-500">
                  {option.description}
                </p>
              )}
            </li>
          ))}
        </ul>
      </div>

      {/* Placeholder for ballot casting — Phase 6 */}
      {typedVote.status === "open" && (
        <div className="rounded-lg border-2 border-dashed border-gray-300 p-6 text-center text-sm text-gray-500">
          Ballot casting will be implemented in Phase 6.
        </div>
      )}
    </div>
  );
}
```

2. Verify the app compiles:

```bash
cd /Users/briantse/Projects/group-vote
npm run build
```

3. Commit:

```bash
git add "src/app/(protected)/votes/[id]/"
git commit -m "Add vote detail page with config summary, participation bar, and options list"
```

---

<!-- CONTINUED IN PART 2 -->
